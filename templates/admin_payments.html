<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>付款清單</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system; margin: 24px; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 14px; }
    th { text-align: left; background: #fafafa; }
    .meta { color: #666; font-size: 12px; margin-bottom: 12px; }
    .pager { display: flex; gap: 8px; margin-top: 12px; }
    .btn { padding: 6px 10px; border: 1px solid #ddd; text-decoration: none; color: #111; border-radius: 6px; }
    .btn.disabled { color: #999; border-color: #eee; pointer-events: none; }
    .status-paid { color: #066a2b; font-weight: 600; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .filters { display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0 12px; }
    .filters input { padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
    .filters .btn { background:#111827; color:#fff; border-color:#111827; }
    .filters .link { text-decoration:none; color:#2563eb; padding:6px 4px; }
  </style>
</head>
<body>
  <h1>付款清單</h1>

  <!-- 篩選列 -->
  <form class="filters" method="get">
    <input type="text" name="q" placeholder="搜尋 email / 課程代號" value="{{ q or '' }}">
    <input type="date" name="date_from" value="{{ date_from or '' }}">
    <input type="date" name="date_to" value="{{ date_to or '' }}">
    <input type="hidden" name="page_size" value="{{ page_size }}">
    <button class="btn" type="submit">套用篩選</button>
    <a class="link" href="{{ request.path }}">清除篩選</a>
  </form>

  <div class="meta">
    共 {{ total }} 筆；第 {{ page }} 頁（每頁 {{ page_size }} 筆）
  </div>

  <table>
    <thead>
      <tr>
        <th>時間</th>
        <th>課程</th>
        <th>金額(元)</th>
        <th>狀態</th>
        <th>Email</th>
        <th>Session</th>
      </tr>
    </thead>
    <tbody>
    {% if rows %}
      {% for r in rows %}
      <tr>
        <td>{{ r.created_at.strftime("%Y-%m-%d %H:%M") if r.created_at else "-" }}</td>
        <td>{{ r.course_id }}</td>
        <td class="mono">{{ r.amount_twd }}</td>
        <td class="{{ 'status-paid' if (r.status or '').lower() == 'paid' else '' }}">{{ r.status }}</td>
        <td>{{ r.buyer_email or "-" }}</td>
        <td class="mono" title="{{ r.stripe_session_id }}">{{ r.stripe_session_id[:10] ~ "…" }}</td>
      </tr>
      {% endfor %}
    {% else %}
      <tr><td colspan="6">尚無資料</td></tr>
    {% endif %}
    </tbody>
  </table>

  <div class="pager">
    {% set base = request.path %}
    {% set qs_prev = ('?page=' ~ (page-1) ~ '&page_size=' ~ page_size ~ (q and '&q=' ~ q or '') ~ (date_from and '&date_from=' ~ date_from or '') ~ (date_to and '&date_to=' ~ date_to or '')) %}
    {% set qs_next = ('?page=' ~ (page+1) ~ '&page_size=' ~ page_size ~ (q and '&q=' ~ q or '') ~ (date_from and '&date_from=' ~ date_from or '') ~ (date_to and '&date_to=' ~ date_to or '')) %}
    <a class="btn {{ '' if has_prev else 'disabled' }}" href="{{ base ~ qs_prev }}">上一頁</a>
    <a class="btn {{ '' if has_next else 'disabled' }}" href="{{ base ~ qs_next }}">下一頁</a>
  </div>
</body>
</html>
